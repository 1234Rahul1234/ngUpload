angular.module("ngUpload",[]).directive("uploadSubmit",["$parse",function(t){function e(t,n){t=angular.element(t);var a=t.parent();return n=n.toLowerCase(),a&&a[0].tagName.toLowerCase()===n?a:a?e(a,n):null}return{restrict:"AC",link:function(n,a,o){var r={};o.hasOwnProperty("uploadOptionsConvertHidden")&&(r.convertHidden="false"!=o.uploadOptionsConvertHidden),o.hasOwnProperty("uploadOptionBeforeSubmit")&&(r.beforeSubmitCallback=o.uploadOptionBeforeSubmit);var i=e(a,"form"),l=t(o.uploadSubmit);if(!angular.isFunction(l)){var d="The expression on the ngUpload directive does not point to a valid function.";throw d+"\n"}a.bind("click",function(t){if(t&&t.preventDefault(),!a.attr("disabled")){if(void 0!==r.beforeSubmitCallback){var e=n.$apply(function(){return n[r.beforeSubmitCallback](n,t)});if(e===!1)return!1}var o=angular.element("<iframe id='upload_iframe' name='upload_iframe' border='0' width='0' height='0' style='width: 0px; height: 0px; border: none; display: none' />");i.parent().append(o),o.bind("load",function(){var t=o[0],e=t.contentDocument||t.contentWindow.document,a=e.body.innerText||e.body.textContent;try{a=JSON.parse(a)}catch(r){console&&console.log("WARN: XHR response is not valid json")}n.$$phase?l(n,{content:a,completed:!0}):n.$apply(function(){l(n,{content:a,completed:!0})}),""!==a&&setTimeout(function(){o.remove()},250)}),n.$$phase?l(n,{content:"Please wait...",completed:!1}):n.$apply(function(){l(n,{content:"Please wait...",completed:!1})}),r.convertHidden&&angular.forEach(i.find("input"),function(t){t=angular.element(t),t.attr("ng-model")&&t.attr("type")&&"hidden"==t.attr("type")&&t.attr("value",n.$eval(t.attr("ng-model")))}),i[0].submit()}}).attr("title","Click to start upload.")}}}]).directive("ngUpload",["$parse","$document",function(t,e){function n(t){var n,a=e.find("head");return angular.forEach(a.find("meta"),function(e){e.getAttribute("name")===t&&(n=e)}),angular.element(n)}return{restrict:"AC",link:function(t,e,a){var o={};a.hasOwnProperty("uploadOptionsEnableRailsCsrf")&&(o.enableRailsCsrf="false"!=a.uploadOptionsEnableRailsCsrf),e.attr("target","upload_iframe"),e.attr("method","post");var r=-1==e.attr("action").indexOf("?")?"?":"&";if(e.attr("action",e.attr("action")+r+"_t="+(new Date).getTime()),e.attr("enctype","multipart/form-data"),e.attr("encoding","multipart/form-data"),o.enableRailsCsrf){var i=angular.element("<input />");i.attr("class","upload-csrf-token"),i.attr("type","hidden"),i.attr("name",n("csrf-param").attr("content")),i.val(n("csrf-token").attr("content")),e.append(i)}}}}]);